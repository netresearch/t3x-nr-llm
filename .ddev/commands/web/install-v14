#!/bin/bash

## Description: Install TYPO3 14 with nr_llm extension
## Usage: install-v14
## Example: ddev install-v14

set -e

VERSION=v14
INSTALL_DIR="/var/www/html/$VERSION"
EXTENSION_PATH="/var/www/nr_llm"

echo "ðŸš€ Installing TYPO3 v14 with nr_llm extension..."
echo ""

# Clean and create installation directory
echo "ðŸ“ Creating installation directory..."
rm -rf "$INSTALL_DIR"/* "$INSTALL_DIR"/.[!.]* 2>/dev/null || true
mkdir -p "$INSTALL_DIR"

# Create database
echo "ðŸ—„ï¸ Setting up database..."
mysql -h db -u root -p"root" -e "DROP DATABASE IF EXISTS ${VERSION};"
mysql -h db -u root -p"root" -e "CREATE DATABASE ${VERSION};"

# Install TYPO3 base distribution
echo "ðŸ“¦ Installing TYPO3 v14 base distribution..."
cd "$INSTALL_DIR"
composer create-project typo3/cms-base-distribution:^14 . --no-interaction --no-progress

# Remove PHP platform override to use actual PHP 8.5
echo "ðŸ”§ Removing platform PHP override..."
composer config --unset platform.php

# Add extension repository and install
echo "ðŸ”Œ Adding nr_llm extension..."
composer config repositories.nr_llm path "$EXTENSION_PATH"
composer require netresearch/nr-llm:@dev --no-interaction --no-progress

# Add dev dependencies
echo "ðŸ“¦ Installing development packages..."
composer require --dev typo3/cms-styleguide --no-interaction --no-progress

# Setup TYPO3
echo "âš™ï¸ Running TYPO3 setup..."
vendor/bin/typo3 setup -n \
    --dbname="$VERSION" \
    --password=root \
    --create-site="https://${VERSION}.nr-llm.ddev.site" \
    --admin-user-password="$TYPO3_SETUP_ADMIN_PASSWORD"

# Configure development settings via additional.php (v14 removed CLI configuration commands)
echo "ðŸ”§ Configuring development settings..."
mkdir -p "$INSTALL_DIR/config/system"
cat > "$INSTALL_DIR/config/system/additional.php" << 'EOF'
<?php
// Development settings
$GLOBALS['TYPO3_CONF_VARS']['BE']['debug'] = true;
$GLOBALS['TYPO3_CONF_VARS']['FE']['debug'] = true;
$GLOBALS['TYPO3_CONF_VARS']['SYS']['devIPmask'] = '*';
$GLOBALS['TYPO3_CONF_VARS']['SYS']['displayErrors'] = 1;

// Mail configuration (Mailpit)
$GLOBALS['TYPO3_CONF_VARS']['MAIL']['transport'] = 'smtp';
$GLOBALS['TYPO3_CONF_VARS']['MAIL']['transport_smtp_server'] = 'localhost:1025';
$GLOBALS['TYPO3_CONF_VARS']['MAIL']['defaultMailFromAddress'] = 'admin@example.com';

// Graphics
$GLOBALS['TYPO3_CONF_VARS']['GFX']['processor'] = 'ImageMagick';
$GLOBALS['TYPO3_CONF_VARS']['GFX']['processor_path'] = '/usr/bin/';

// Security settings for DDEV multi-subdomain environment
$GLOBALS['TYPO3_CONF_VARS']['SYS']['trustedHostsPattern'] = '.*';
$GLOBALS['TYPO3_CONF_VARS']['SYS']['features']['security.backend.enforceReferrer'] = false;

// Note: Valkey caching disabled - requires php-redis extension
// Use default file-based caching for development
EOF

# Setup extensions
echo "ðŸ”Œ Setting up extensions..."
vendor/bin/typo3 extension:setup

# Generate styleguide demo content
echo "ðŸ“ Generating styleguide demo content..."
vendor/bin/typo3 styleguide:generate || echo "âš ï¸ Styleguide generation skipped"

# Flush caches
vendor/bin/typo3 cache:flush

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… TYPO3 $VERSION installation complete!"
echo ""
echo "ðŸŒ Frontend: https://v14.nr-llm.ddev.site/"
echo "ðŸ”§ Backend:  https://v14.nr-llm.ddev.site/typo3/"
echo ""
echo "ðŸ“‹ Credentials:"
echo "   Username: admin"
echo "   Password: Joh316!!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
