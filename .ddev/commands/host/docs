#!/bin/bash

## Description: Render TYPO3 documentation using render-guides
## Usage: docs [--clean]
## Example: ddev docs
## Example: ddev docs --clean

set -e

PROJECT_DIR="$(dirname "$(dirname "$(dirname "$0")")")/.."
cd "$PROJECT_DIR"

DOC_SOURCE="${PROJECT_DIR}/Documentation"
DOC_OUTPUT="${PROJECT_DIR}/Documentation-GENERATED-temp"

echo "๐ Rendering TYPO3 Extension Documentation"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Check if Documentation directory exists
if [ ! -d "$DOC_SOURCE" ]; then
    echo "โ Error: Documentation directory not found"
    echo "๐ก Tip: Create a Documentation/ directory with Index.rst to get started"
    exit 1
fi

# Check for --clean flag or clean previous output
if [[ "$1" == "--clean" ]] || [ -d "$DOC_OUTPUT" ]; then
    echo "๐งน Cleaning previous documentation build..."
    rm -rf "$DOC_OUTPUT"
fi

echo "๐ Source:  Documentation/"
echo "๐ฆ Output:  Documentation-GENERATED-temp/"
echo ""

# Render documentation using TYPO3's official docker image
echo "๐จ Rendering documentation with TYPO3 render-guides..."
echo ""

docker run --rm \
    -v "$(pwd):/project" \
    --user "$(id -u):$(id -g)" \
    ghcr.io/typo3-documentation/render-guides:latest \
    --config=/project/Documentation \
    --output=/project/Documentation-GENERATED-temp \
    --no-progress 2>&1

if [ $? -eq 0 ]; then
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ Documentation rendered successfully!"
    echo ""
    echo "๐ View at: https://docs.nr-llm.ddev.site/"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
else
    echo ""
    echo "โ Documentation rendering failed"
    echo "๐ก Check your .rst files for syntax errors"
    exit 1
fi
