name: nr-llm
type: php
docroot: ""
no_project_mount: true
php_version: "8.5"
composer_version: "2"
webserver_type: apache-fpm
router_http_port: "80"
router_https_port: "443"
xdebug_enabled: false
database:
  type: mariadb
  version: "11.4"
additional_hostnames:
  - docs.nr-llm
  - v14.nr-llm
additional_fqdns: []
use_dns_when_possible: true
hooks:
  post-start:
    - exec-host: |
        # Capture git info and write to container automatically on every ddev start
        BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        PR=$(gh pr view --json number -q .number 2>/dev/null || echo "unknown")

        # Write git info as JSON to web container
        ddev exec "printf '{\"branch\":\"%s\",\"commit\":\"%s\",\"pr\":\"%s\"}' '$BRANCH' '$COMMIT' '$PR' > /var/www/html/.git-info.json"

        echo "ðŸ“‹ Git info updated: Branch=$BRANCH, Commit=$COMMIT, PR=$PR"
    - exec-host: |
        # Auto-pull Ollama model in background (if not already present)
        OLLAMA_MODEL="${OLLAMA_MODEL:-qwen3:0.6b}"
        OLLAMA_CONTAINER="ddev-${DDEV_SITENAME}-ollama"

        # Wait for Ollama container to be ready (use ollama list, no curl in image)
        echo "ðŸ¤– Checking Ollama container..."
        for i in {1..30}; do
          if docker exec "$OLLAMA_CONTAINER" ollama list >/dev/null 2>&1; then
            break
          fi
          sleep 1
        done

        # Check if model exists, if not pull it in background
        if ! docker exec "$OLLAMA_CONTAINER" ollama list 2>/dev/null | grep -q "$OLLAMA_MODEL"; then
          echo "ðŸ¤– Pulling Ollama model: $OLLAMA_MODEL (running in background)..."
          nohup docker exec "$OLLAMA_CONTAINER" ollama pull "$OLLAMA_MODEL" >/dev/null 2>&1 &
          echo "   Run 'ddev ollama list' to check progress"
        else
          echo "ðŸ¤– Ollama model ready: $OLLAMA_MODEL"
        fi
