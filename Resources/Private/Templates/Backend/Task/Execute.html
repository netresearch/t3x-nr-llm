<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      xmlns:be="http://typo3.org/ns/TYPO3/CMS/Backend/ViewHelpers"
      xmlns:core="http://typo3.org/ns/TYPO3/CMS/Core/ViewHelpers"
      data-namespace-typo3-fluid="true">

<f:layout name="Module" />

<f:section name="Content">
    <div class="container" data-task-execute data-task-uid="{task.uid}">

        <f:be.infobox
            title="One-Shot Prompt"
            state="{f:constant(name: 'TYPO3\CMS\Core\Type\ContextualFeedbackSeverity::NOTICE')}"
        >
            <p>
                This is a <strong>simple one-shot prompt</strong> - it sends your input to the LLM once and returns the response.
                It cannot reason across multiple steps, use external tools, or remember previous interactions.
                For complex tasks, consider using a proper AI agent framework.
            </p>
        </f:be.infobox>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <core:icon identifier="actions-play" size="medium" />
                Execute: {task.name}
            </h1>
            <a href="{be:moduleLink(route: 'nrllm_tasks')}" class="btn btn-default">
                <core:icon identifier="actions-view-go-back" size="small" />
                Back to List
            </a>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h2 class="card-title mb-0">
                            <core:icon identifier="actions-upload" size="small" />
                            Input
                        </h2>
                    </div>
                    <div class="card-body">
                        <f:if condition="{task.description}">
                            <p class="text-muted mb-3">{task.description}</p>
                        </f:if>

                        <f:if condition="{requiresManualInput}">
                            <f:then>
                                <!-- Table picker for manual input tasks -->
                                <div class="card bg-light mb-3" id="tablePickerCard">
                                    <div class="card-header py-2">
                                        <button type="button" class="btn btn-link text-decoration-none p-0 collapsed"
                                                data-bs-toggle="collapse" data-bs-target="#tablePickerCollapse"
                                                aria-expanded="false" aria-controls="tablePickerCollapse">
                                            <core:icon identifier="actions-database" size="small" />
                                            Load data from database table
                                            <span class="ms-1"><core:icon identifier="actions-chevron-down" size="small" /></span>
                                        </button>
                                    </div>
                                    <div class="collapse" id="tablePickerCollapse">
                                        <div class="card-body">
                                            <div class="row g-2">
                                                <div class="col-md-5">
                                                    <label class="form-label small">Select Table</label>
                                                    <select class="form-select form-select-sm" id="tableSelect">
                                                        <option value="">-- Load tables --</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-5">
                                                    <label class="form-label small">Select Records</label>
                                                    <select class="form-select form-select-sm" id="recordSelect" multiple size="4" disabled>
                                                        <option value="">Select a table first</option>
                                                    </select>
                                                    <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                                                </div>
                                                <div class="col-md-2 d-flex align-items-end">
                                                    <button type="button" class="btn btn-primary btn-sm w-100" id="loadRecordsBtn" disabled>
                                                        <core:icon identifier="actions-download" size="small" />
                                                        Load
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </f:then>
                        </f:if>

                        <div class="mb-3">
                            <label for="taskInput" class="form-label">
                                <f:if condition="{requiresManualInput}">
                                    <f:then>Enter your input:</f:then>
                                    <f:else>
                                        Auto-fetched data ({task.inputType}):
                                        <span class="badge text-bg-info">Auto-populated</span>
                                    </f:else>
                                </f:if>
                            </label>
                            <textarea class="form-control font-monospace" id="taskInput" rows="15"
                                      placeholder="Enter the data to analyze...">{inputData}</textarea>

                            <!-- Empty data feedback for auto-fetch tasks -->
                            <f:if condition="!{requiresManualInput}">
                                <div id="emptyDataWarning" class="alert alert-warning mt-2 {f:if(condition: inputData, then: 'd-none')}">
                                    <core:icon identifier="actions-exclamation-triangle" size="small" />
                                    <strong>No data available.</strong>
                                    <f:switch expression="{task.inputType}">
                                        <f:case value="syslog">
                                            The system log (sys_log) contains no matching entries. This is normal for a fresh installation.
                                        </f:case>
                                        <f:case value="deprecation_log">
                                            No deprecation log found. The file <code>var/log/typo3_deprecations.log</code> may not exist yet.
                                        </f:case>
                                        <f:case value="table">
                                            The configured table is empty or the table/field configuration is missing.
                                        </f:case>
                                        <f:defaultCase>
                                            No data could be fetched automatically.
                                        </f:defaultCase>
                                    </f:switch>
                                    You can still enter data manually above.
                                </div>
                            </f:if>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-success btn-lg" id="executeBtn">
                                <span class="btn-content">
                                    <core:icon identifier="actions-play" size="small" />
                                    Execute Task
                                </span>
                                <span class="btn-loading d-none">
                                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                    Executing...
                                </span>
                            </button>
                            <f:if condition="!{requiresManualInput}">
                                <button type="button" class="btn btn-default" id="refreshInputBtn">
                                    <core:icon identifier="actions-refresh" size="small" />
                                    Refresh Data
                                </button>
                            </f:if>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title mb-0">
                            <core:icon identifier="actions-code" size="small" />
                            Prompt Template
                        </h2>
                    </div>
                    <div class="card-body">
                        <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;"><code>{task.promptTemplate}</code></pre>
                        <small class="text-muted">
                            <code>{"{{input}}"}</code> will be replaced with the input above.
                        </small>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2 class="card-title mb-0">
                            <core:icon identifier="actions-download" size="small" />
                            Output
                            <span class="badge text-bg-secondary ms-2">{task.outputFormat}</span>
                        </h2>
                        <div id="outputStatus" class="d-none">
                            <span class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </span>
                            Processing...
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="outputPlaceholder" class="text-center text-muted py-5">
                            <core:icon identifier="actions-play" size="large" />
                            <p class="mt-3">Click "Execute Task" to run this task</p>
                        </div>

                        <div id="outputLoading" class="d-none text-center py-5">
                            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Processing...</span>
                            </div>
                            <h4 class="text-primary">Processing request...</h4>
                            <p class="text-muted mb-2">Sending to LLM and waiting for response</p>
                            <div class="progress mx-auto" style="width: 200px; height: 4px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 100%"></div>
                            </div>
                            <p class="text-muted mt-3 small">
                                <span id="elapsedTime">0</span>s elapsed
                            </p>
                        </div>

                        <div id="outputError" class="d-none">
                            <div class="alert alert-danger">
                                <strong>Error:</strong>
                                <span id="errorMessage"></span>
                            </div>
                        </div>

                        <div id="outputResult" class="d-none">
                            <div id="outputContent" class="bg-light p-3 rounded" style="max-height: 500px; overflow-y: auto;"></div>

                            <div class="mt-3 d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    Model: <span id="outputModel">-</span>
                                </small>
                                <small class="text-muted">
                                    Tokens: <span id="outputTokens">-</span>
                                </small>
                            </div>

                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-default" id="copyOutputBtn">
                                    <core:icon identifier="actions-clipboard" size="small" />
                                    Copy to Clipboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</f:section>

</html>
