<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      xmlns:be="http://typo3.org/ns/TYPO3/CMS/Backend/ViewHelpers"
      xmlns:core="http://typo3.org/ns/TYPO3/CMS/Core/ViewHelpers"
      data-namespace-typo3-fluid="true">

<f:layout name="Module" />

<f:section name="Content">
    <div class="container">
        <h1>
            <f:if condition="{isNew}">
                <f:then><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.edit.new" default="New LLM Configuration" /></f:then>
                <f:else><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.edit.edit" default="Edit LLM Configuration" />: {configuration.name}</f:else>
            </f:if>
        </h1>

        <f:if condition="{isNew}">
        <f:then>
            <f:form action="create" method="post">
                <f:render section="FormFields" arguments="{_all}" />
            </f:form>
        </f:then>
        <f:else>
            <f:form action="update" method="post" arguments="{uid: configuration.uid}">
                <f:render section="FormFields" arguments="{_all}" />
            </f:form>
        </f:else>
    </f:if>
    </div>
</f:section>

<f:section name="FormFields">
    <div class="row">
        <div class="col-lg-8">
            <f:comment>Identity Section</f:comment>
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.section.identity" default="Identity" /></h2>
                </div>
                <div class="card-body">
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="identifier">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.identifier" default="Identifier" /> *
                        </label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="identifier"
                                   name="configuration[identifier]"
                                   value="{configuration.identifier}"
                                   required
                                   pattern="[a-z0-9_-]+"
                                   placeholder="my_config_identifier" />
                            <div class="form-text"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.identifier.help" default="Unique technical identifier (lowercase, no spaces)" /></div>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="name">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.name" default="Name" /> *
                        </label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="name"
                                   name="configuration[name]"
                                   value="{configuration.name}"
                                   required
                                   placeholder="My Configuration" />
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="description">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.description" default="Description" />
                        </label>
                        <div class="col-sm-9">
                            <textarea class="form-control" id="description"
                                      name="configuration[description]"
                                      rows="2"
                                      placeholder="{f:translate(key: 'LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:optional')}">{configuration.description}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <f:comment>Model Section</f:comment>
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.section.model" default="Model" /></h2>
                </div>
                <div class="card-body">
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="modelUid">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.model" default="LLM Model" /> *
                        </label>
                        <div class="col-sm-9">
                            <select class="form-select" id="modelUid"
                                    name="configuration[modelUid]"
                                    required>
                                <option value="">-- <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:selectModel" default="Select Model" /> --</option>
                                <f:for each="{models}" as="modelItem">
                                    <option value="{modelItem.uid}"
                                            {f:if(condition: '{configuration.modelUid} == {modelItem.uid}', then: 'selected')}>
                                        {modelItem.name} ({modelItem.provider.name} - {modelItem.modelId})
                                    </option>
                                </f:for>
                            </select>
                            <div class="form-text"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.model.help" default="Select a configured model from the Models list" /></div>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="translator">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.translator" default="Translator" />
                        </label>
                        <div class="col-sm-9">
                            <select class="form-select" id="translator"
                                    name="configuration[translator]">
                                <option value="" {f:if(condition: '!{configuration.translator}', then: 'selected')}><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:translator.none" default="None (use LLM)" /></option>
                                <option value="deepl" {f:if(condition: '{configuration.translator} == "deepl"', then: 'selected')}>DeepL</option>
                            </select>
                            <div class="form-text"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.translator.help" default="Optional translation service override" /></div>
                        </div>
                    </div>
                </div>
            </div>

            <f:comment>Parameters Section</f:comment>
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.section.parameters" default="Model Parameters" /></h2>
                </div>
                <div class="card-body">
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="systemPrompt">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.systemPrompt" default="System Prompt" />
                        </label>
                        <div class="col-sm-9">
                            <textarea class="form-control" id="systemPrompt"
                                      name="configuration[systemPrompt]"
                                      rows="4"
                                      placeholder="You are a helpful assistant...">{configuration.systemPrompt}</textarea>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="temperature">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.temperature" default="Temperature" />
                        </label>
                        <div class="col-sm-9">
                            <input type="number" class="form-control" id="temperature"
                                   name="configuration[temperature]"
                                   value="{f:if(condition: configuration, then: configuration.temperature, else: '0.7')}"
                                   min="0" max="2" step="0.1" />
                            <div class="form-text"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.temperature.help" default="Controls randomness (0.0 = deterministic, 2.0 = very creative)" /></div>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="maxTokens">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.maxTokens" default="Max Tokens" />
                        </label>
                        <div class="col-sm-9">
                            <input type="number" class="form-control" id="maxTokens"
                                   name="configuration[maxTokens]"
                                   value="{f:if(condition: configuration, then: configuration.maxTokens, else: '1000')}"
                                   min="1" max="128000" />
                            <div class="form-text"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.maxTokens.help" default="Maximum number of tokens in the response" /></div>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="timeout">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.timeout" default="Timeout Override" />
                        </label>
                        <div class="col-sm-9">
                            <div class="input-group">
                                <input type="number" class="form-control" id="timeout"
                                       name="configuration[timeout]"
                                       value="{f:if(condition: configuration, then: configuration.timeout, else: '0')}"
                                       min="0" max="600" />
                                <span class="input-group-text"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:seconds" default="seconds" /></span>
                            </div>
                            <div class="form-text"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.timeout.help" default="Override model timeout (0 = use model default)" /></div>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="topP">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.topP" default="Top P" />
                        </label>
                        <div class="col-sm-9">
                            <input type="number" class="form-control" id="topP"
                                   name="configuration[topP]"
                                   value="{f:if(condition: configuration, then: configuration.topP, else: '1.0')}"
                                   min="0" max="1" step="0.01" />
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="frequencyPenalty">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.frequencyPenalty" default="Frequency Penalty" />
                        </label>
                        <div class="col-sm-9">
                            <input type="number" class="form-control" id="frequencyPenalty"
                                   name="configuration[frequencyPenalty]"
                                   value="{f:if(condition: configuration, then: configuration.frequencyPenalty, else: '0.0')}"
                                   min="-2" max="2" step="0.1" />
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="presencePenalty">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.presencePenalty" default="Presence Penalty" />
                        </label>
                        <div class="col-sm-9">
                            <input type="number" class="form-control" id="presencePenalty"
                                   name="configuration[presencePenalty]"
                                   value="{f:if(condition: configuration, then: configuration.presencePenalty, else: '0.0')}"
                                   min="-2" max="2" step="0.1" />
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="options">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.options" default="Additional Options" />
                        </label>
                        <div class="col-sm-9">
                            <textarea class="form-control" id="options"
                                      name="configuration[options]"
                                      rows="3"
                                      placeholder='{"stop_sequences": ["\n\n"]}'>{configuration.options}</textarea>
                            <div class="form-text"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.options.help" default="Additional options as JSON (optional)" /></div>
                        </div>
                    </div>
                </div>
            </div>

            <f:comment>Usage Limits Section</f:comment>
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.section.limits" default="Usage Limits" /></h2>
                </div>
                <div class="card-body">
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="maxRequestsPerDay">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.maxRequestsPerDay" default="Max Requests/Day" />
                        </label>
                        <div class="col-sm-9">
                            <input type="number" class="form-control" id="maxRequestsPerDay"
                                   name="configuration[maxRequestsPerDay]"
                                   value="{f:if(condition: configuration, then: configuration.maxRequestsPerDay, else: '0')}"
                                   min="0" />
                            <div class="form-text"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.maxRequestsPerDay.help" default="Maximum requests per day (0 = unlimited)" /></div>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="maxTokensPerDay">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.maxTokensPerDay" default="Max Tokens/Day" />
                        </label>
                        <div class="col-sm-9">
                            <input type="number" class="form-control" id="maxTokensPerDay"
                                   name="configuration[maxTokensPerDay]"
                                   value="{f:if(condition: configuration, then: configuration.maxTokensPerDay, else: '0')}"
                                   min="0" />
                            <div class="form-text"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.maxTokensPerDay.help" default="Maximum tokens per day (0 = unlimited)" /></div>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-3 col-form-label" for="maxCostPerDay">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.maxCostPerDay" default="Max Cost/Day ($)" />
                        </label>
                        <div class="col-sm-9">
                            <input type="number" class="form-control" id="maxCostPerDay"
                                   name="configuration[maxCostPerDay]"
                                   value="{f:if(condition: configuration, then: configuration.maxCostPerDay, else: '0.00')}"
                                   min="0" step="0.01" />
                            <div class="form-text"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.field.maxCostPerDay.help" default="Maximum cost per day in USD (0 = unlimited)" /></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <f:comment>Status Section</f:comment>
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title"><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:configuration.section.status" default="Status" /></h2>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input type="hidden" name="configuration[isActive]" value="0" />
                        <input type="checkbox" class="form-check-input" id="isActive"
                               name="configuration[isActive]" value="1"
                               {f:if(condition: '{configuration.isActive} || {isNew}', then: 'checked')} />
                        <label class="form-check-label" for="isActive">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:active" default="Active" />
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input type="hidden" name="configuration[isDefault]" value="0" />
                        <input type="checkbox" class="form-check-input" id="isDefault"
                               name="configuration[isDefault]" value="1"
                               {f:if(condition: configuration.isDefault, then: 'checked')} />
                        <label class="form-check-label" for="isDefault">
                            <f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:defaultConfiguration" default="Default Configuration" />
                        </label>
                    </div>
                </div>
            </div>

            <f:comment>Actions</f:comment>
            <div class="card">
                <div class="card-body">
                    <button type="submit" class="btn btn-primary w-100 mb-2">
                        <core:icon identifier="actions-save" size="small" />
                        <f:if condition="{isNew}">
                            <f:then><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:createConfiguration" default="Create Configuration" /></f:then>
                            <f:else><f:translate key="LLL:EXT:nr_llm/Resources/Private/Language/locallang.xlf:saveConfiguration" default="Save Configuration" /></f:else>
                        </f:if>
                    </button>
                    <f:link.action action="list" class="btn btn-default w-100">
                        <f:translate key="LLL:EXT:core/Resources/Private/Language/locallang_common.xlf:cancel" default="Cancel" />
                    </f:link.action>
                </div>
            </div>
        </div>
    </div>
</f:section>

</html>
